{% extends 'base.html' %}

{% block title %}Agregar Detalle de Orden{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow p-4">
        <h2 class="mb-4 text-center text-primary">Agregar Detalle a la Orden</h2>
        <form method="post">
            {% csrf_token %}

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_orden" class="form-label">Orden:</label>
                    <select class="form-select" id="id_orden" name="orden" required>
                        <option value="">Seleccione una orden</option>
                        {% for ord in ordenes %}
                            <option value="{{ ord.pk }}">Orden #{{ ord.id }} - {{ ord.vehiculo.marca }} {{ ord.vehiculo.modelo }} ({{ ord.cliente.nombre }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="id_tipo_cargo" class="form-label">Tipo de Cargo:</label>
                    <select class="form-select" id="id_tipo_cargo" name="tipo_cargo" required>
                        <option value="">Seleccione tipo</option>
                        <option value="servicio">Servicio</option>
                        <option value="refaccion">Refacción</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_servicio" class="form-label">Servicio (opcional):</label>
                    <select class="form-select" id="id_servicio" name="servicio">
                        <option value="">Seleccione un servicio</option>
                        {% for serv in servicios %}
                            <option value="{{ serv.pk }}">{{ serv.nombre_servicio }} - ${{ serv.precio_base }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="id_refaccion" class="form-label">Refacción (opcional):</label>
                    <select class="form-select" id="id_refaccion" name="refaccion">
                        <option value="">Seleccione una refacción</option>
                        {% for ref in refacciones %}
                            <option value="{{ ref.pk }}">{{ ref.nombre }} - ${{ ref.precio_compra }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label for="id_descripcion" class="form-label">Descripción del Trabajo / Pieza:</label>
                <textarea class="form-control" id="id_descripcion" name="descripcion" rows="3" required></textarea>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="id_cantidad_uni_hr" class="form-label">Cantidad / Horas:</label>
                    <input type="number" step="0.01" class="form-control" id="id_cantidad_uni_hr" name="cantidad_uni_hr" required>
                </div>
                <div class="col-md-4">
                    <label for="id_precio_unitario" class="form-label">Precio Unitario:</label>
                    <input type="number" step="0.01" class="form-control" id="id_precio_unitario" name="precio_unitario" required>
                </div>
                <div class="col-md-4">
                    <label for="id_subtotal" class="form-label">Subtotal:</label>
                    <input type="number" step="0.01" class="form-control" id="id_subtotal" name="subtotal" readonly required>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="fas fa-plus-circle me-2"></i>Agregar Detalle
                </button>
                <a href="{% url 'ver_detalleorden' %}" class="btn btn-secondary mt-2">
                    <i class="fas fa-arrow-left me-2"></i>Cancelar y Volver
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // Calcula el subtotal automáticamente
    document.addEventListener('DOMContentLoaded', function() {
        const cantidad = document.getElementById('id_cantidad_uni_hr');
        const precio = document.getElementById('id_precio_unitario');
        const subtotal = document.getElementById('id_subtotal');

        function calcularSubtotal() {
            const c = parseFloat(cantidad.value) || 0;
            const p = parseFloat(precio.value) || 0;
            subtotal.value = (c * p).toFixed(2);
        }

        cantidad.addEventListener('input', calcularSubtotal);
        precio.addEventListener('input', calcularSubtotal);
    });
</script>
{% endblock %}
